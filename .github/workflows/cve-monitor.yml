name: CVE Monitor

on:
  schedule:
    # Monday and Thursday at 08:00 UTC
    - cron: '0 8 * * 1,4'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: cve-monitor

jobs:
  scan:
    name: Scan ${{ matrix.image }}
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: read
      issues: write

    strategy:
      fail-fast: false
      matrix:
        image: [ci-tools] # extend when adding images

    steps:
      - name: Checkout
        # Sparse checkout: per-image .trivyignore and the issue body template.
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          sparse-checkout: |
            images/${{ matrix.image }}/.trivyignore
            docs/cve-monitor-issue.md
          sparse-checkout-cone-mode: false

      - name: Scan published image for vulnerabilities
        id: trivy
        continue-on-error: true
        # Same policy as publish: CRITICAL+HIGH, ignore-unfixed
        uses: aquasecurity/trivy-action@c1824fd6edce30d7ab345a9989de00bbd46ef284 # 0.34.0
        with:
          image-ref: 'ghcr.io/knight-owl-dev/${{ matrix.image }}:latest'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          trivyignores: images/${{ matrix.image }}/.trivyignore
          format: 'table'
          output: 'trivy-results.txt'

      - name: Open issue on findings
        if: steps.trivy.outcome == 'failure'
        env:
          GH_TOKEN: ${{ github.token }}
          IMAGE: ${{ matrix.image }}
        run: |
          open_issues=$(
            gh issue list \
              --label cve-monitor \
              --search "in:title ${IMAGE}" \
              --state open \
              --limit 1 \
              --json number \
              --jq 'length'
          )
          if [ "${open_issues}" -gt 0 ]; then
            echo "Open cve-monitor issue for ${IMAGE} already exists â€” skipping."
            exit 0
          fi

          sed -e "s/\$IMAGE/${IMAGE}/g" -e '/<!-- TRIVY_RESULTS -->/{
            r trivy-results.txt
            d
          }' docs/cve-monitor-issue.md > /tmp/issue-body.md

          gh issue create \
            --title "CVE Monitor: fixable vulnerabilities in ${IMAGE}" \
            --body-file /tmp/issue-body.md \
            --label cve-monitor --label security
